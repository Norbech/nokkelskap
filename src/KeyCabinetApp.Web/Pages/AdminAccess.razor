@page "/admin/access"
@using KeyCabinetApp.Core.Entities
@using KeyCabinetApp.Core.Interfaces
@using KeyCabinetApp.Web.Services
@using KeyCabinetApp.Infrastructure.Data
@inject IUserRepository UserRepository
@inject IKeyRepository KeyRepository
@inject SessionStateService SessionState
@inject NavigationManager Navigation
@inject ApplicationDbContext DbContext

<PageTitle>Tilgangsstyring</PageTitle>

@if (SessionState.CurrentUser == null || !SessionState.CurrentUser.IsAdmin)
{
    <div class="access-denied">
        <h2>Ingen tilgang</h2>
        <p>Du m√• v√¶re administrator for √• se denne siden.</p>
        <button class="btn-primary" @onclick="@(() => Navigation.NavigateTo("/admin"))">Tilbake</button>
    </div>
}
else
{
    <div class="admin-container">
        <div class="admin-header">
            <h1>üîê Tilgangsstyring</h1>
            <button class="btn-outline" @onclick="@(() => Navigation.NavigateTo("/admin"))">Tilbake</button>
        </div>

        <div class="access-matrix-container">
            <p class="info-text">Velg hvilke kj√∏ret√∏y hver bruker skal ha tilgang til:</p>
            
            <table class="access-matrix">
                <thead>
                    <tr>
                        <th>Bruker</th>
                        @foreach (var key in Keys.OrderBy(k => k.SlotId))
                        {
                            <th class="key-header">
                                <div>@key.Name</div>
                                <small>Slot @key.SlotId</small>
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in Users.OrderBy(u => u.Name))
                    {
                        <tr>
                            <td class="user-cell">
                                <strong>@user.Name</strong>
                                <small>@user.Username</small>
                            </td>
                            @foreach (var key in Keys.OrderBy(k => k.SlotId))
                            {
                                var hasAccess = UserAccess.Any(ua => ua.UserId == user.Id && ua.KeyId == key.Id);
                                <td class="access-cell">
                                    <input type="checkbox" 
                                           checked="@hasAccess" 
                                           @onchange="async (e) => await ToggleAccess(user.Id, key.Id, (bool)e.Value!)" />
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>

            @if (Users.Count == 0 || Keys.Count == 0)
            {
                <div class="no-data">
                    @if (Users.Count == 0)
                    {
                        <p>Ingen brukere funnet. <a href="/admin/users">Opprett brukere f√∏rst</a></p>
                    }
                    @if (Keys.Count == 0)
                    {
                        <p>Ingen kj√∏ret√∏y funnet. <a href="/admin/keys">Registrer kj√∏ret√∏y f√∏rst</a></p>
                    }
                </div>
            }
        </div>

        <p class="success-message">@SuccessMessage</p>
    </div>
}

@code {
    private List<User> Users { get; set; } = new();
    private List<Key> Keys { get; set; } = new();
    private List<UserKeyAccess> UserAccess { get; set; } = new();
    private string SuccessMessage { get; set; } = string.Empty;
    private bool _hasInitialized;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_hasInitialized)
        {
            await SessionState.InitializeAsync();
            _hasInitialized = true;

            if (SessionState.CurrentUser == null || !SessionState.CurrentUser.IsAdmin)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            await LoadData();
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Initialization now happens in OnAfterRenderAsync
    }

    private async Task LoadData()
    {
        Users = (await UserRepository.GetAllAsync()).ToList();
        Keys = (await KeyRepository.GetAllAsync()).ToList();
        UserAccess = DbContext.Set<UserKeyAccess>().ToList();
    }

    private async Task ToggleAccess(int userId, int keyId, bool hasAccess)
    {
        try
        {
            if (hasAccess)
            {
                // Gi tilgang
                var access = new UserKeyAccess
                {
                    UserId = userId,
                    KeyId = keyId,
                    GrantedAt = DateTime.UtcNow
                };
                DbContext.Set<UserKeyAccess>().Add(access);
            }
            else
            {
                // Fjern tilgang
                var existing = UserAccess.FirstOrDefault(ua => ua.UserId == userId && ua.KeyId == keyId);
                if (existing != null)
                {
                    DbContext.Set<UserKeyAccess>().Remove(existing);
                }
            }

            await DbContext.SaveChangesAsync();
            await LoadData();

            var user = Users.First(u => u.Id == userId);
            var key = Keys.First(k => k.Id == keyId);
            SuccessMessage = hasAccess 
                ? $"‚úì {user.Name} har n√• tilgang til {key.Name}" 
                : $"‚úì Tilgang til {key.Name} fjernet for {user.Name}";
            
            StateHasChanged();
            
            await Task.Delay(2000);
            SuccessMessage = string.Empty;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            SuccessMessage = $"‚ùå Feil: {ex.Message}";
        }
    }
}
